
##########################################################
# 3_funnel_plot_limits_data.R
# Thomas Godfrey
# 16/04/2019
# Script 3
# Data preparation for export
# Written/run on R Studio desktop (uses //PHI_conf/)
# R version 3.5.1 
# This script creates CI data for funnel plots in Excel
# see SPss script "2_KPI_graphs_limits_N18.sps" 
##########################################################


### Housekeeping
# Load packages
install.packages('janitor')
install.packages('binom')
library(dplyr)
library(haven)
library(janitor)
library(binom)
library(lubridate)
#library(ggplot2)
#library(tidyr)
#library(reshape2)


## Summary
#STEP 1: Obtain number of people who completed kits with a final result by HB (gives x-axis co-ordinates)
#STEP 2: Obtain number of people with positive result who have a colonoscopy performed by HB (gives x-axis co-ordinates)
#STEP 3: Obtain precentage of people with screen detected cancers with no ICD-10 by HB (seperate chart).
#STEP 4: Calculate Wilson Score confidence intervals for funnel plots (KPIs 3,7,8,17,19,20).
#Notes: The outputs generated by this syntax SHOULD BE copied into HIDDEN worksheets in the Excel KPI report.

## Step 1: Bring in analysis database from script 1
analysis_db <- readRDS(paste0("/PHI_conf/CancerGroup1/Topics/BowelScreening/",
                              "TPP/KPIs/Code + DB/analysis_dataset.rds"))
dim(analysis_db)

# Select statement to keep only required variables
names(analysis_db)
[1] "chinum"         "invdate"        "sex"            "screres"        "haemoglobin"    "screresdate"   
[7] "date_round"     "hbres14"        "simd2009"       "simd2012"       "simd2016"       "age"           
[13] "age_group"      "optin"          "screresdat"     "dateprecol"     "coloffered"     "datecoloff"    
[19] "colperf"        "datecolperf"    "colreason"      "colcomp"        "cancer"         "icd10"         
[25] "tnmt"           "tnmn"           "tnmm"           "dukes"          "adenoma"        "adenno"        
[31] "adensize"       "polypca"        "complicp"       "hbr14"          "invite_n"       "uptake_n"      
[37] "positive_n"     "col_perf_n"     "col_complete_n" "col_complic_n"  "cancer_n"       "polyp_cancer_n"
[43] "adenoma_n"      "lr_adenoma_n"   "ir_adenoma_n"   "hr_adenoma_n"   "date_diff"      "waiting_time"  
[49] "dukes_der"      "uptake_rnd_1"   "uptake_rnd_2"   "uptake_rnd_3"   "uptake_rnd_4"   "uptake_rnd_5"  
[55] "uptake_rnd_6"   "uptake_history"

analysis_db <- analysis_db %>%
  select(analysis_db, invdate, sex)

analysis_db <- analysis_db %>%
  select(analysis_db, 
         c('invdate', 'sex', 'hbr14', 
           'invite_n', 'uptake_n', 'col_perf_n', 'positive_n', 'polyp_cancer_n', 'adenoma_n',
           'hr_adenoma_n'))
dim(analysis_db)

# Filter on dates
analysis_db <- analysis_db %>%
  filter(invdate >= "2017-05-01" & invdate <= "2018-04-30")
dim(analysis_db)
str(analysis_db)

Æ” Two-year reporting period is from 1st of May 2017 to 30th of April 2018 in given years





## Step 2: HB denominator info for x-axis of funnel plots
denom_n_hb <- analysis_db %>%
  filter(hbr14 %in% 1:14) %>%
  group_by(hbr14) %>%
  summarise(
    uptake_n = sum(uptake_n),
    col_perf_n = sum(col_perf_n)
  )

# Calculate Scotland level proportions
scot_p <- analysis_db %>%
  summarise(
    positive_p = sum(positive_n)/sum(uptake_n),
    col_complic_p = sum(col_complic_n)/sum(col_perf_n),
    cancer_p = sum(cancer_n)/sum(uptake_n),
    polyp_cancer_p = sum(polyp_cancer_n)/sum(uptake_n),
    adenoma_p = sum(adenoma_n)/sum(uptake_n),
    hr_adenoma_p = sum(hr_adenoma_n)/sum(uptake_n)
  )









################################################################################
## STEP 1: Obtain the number of people who completed kits with a final result.
# This is used for funnel plots (X-axis for HB data): KPI 3, KPI 8, KPI 17, KPI 19, KPI 20.
################################################################################


################################################################################
## STEP 1: Obtain the number of people who completed kits with a final result.
# This is used for funnel plots (X-axis for HB data): KPI 3, KPI 8, KPI 17, KPI 19, KPI 20.
################################################################################

analysis.db <- read_sav(paste0("//stats/CancerGroup1/Topics/BowelScreening/",
                               "Publications/SBoSP-Statistics/20190205/Analysis/",
                               "data_SUMTABS_Nov18.zsav"))
names(my.data)
head(my.data)

?subset
my.data2 <- subset(my.data, KPI == 1 AND Index1 == 2 AND SEX == 3)
%>%  clean_names()
names(my.data2)


